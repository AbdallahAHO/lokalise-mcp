name: CI - Code Quality

# This workflow runs on every pull request and push to main branches
# It performs formatting checks, linting, building, and testing
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Code Quality Checks
  quality:
    name: ðŸŽ¨ Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: ðŸŽ¨ Check formatting
        id: format
        run: |
          echo "ðŸŽ¨ Checking code formatting with Biome..."
          npm run format
          
          # Check if there are any changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "âŒ Code formatting issues found!"
            echo "formatting_issues=true" >> $GITHUB_OUTPUT
            
            # Show what files would be formatted
            echo "ðŸ“ Files with formatting issues:"
            git status --porcelain
            
            # Create a comment body
            echo "## ðŸŽ¨ Formatting Issues Found" >> format-comment.md
            echo "" >> format-comment.md
            echo "Please run \`npm run format\` locally to fix formatting issues." >> format-comment.md
            echo "" >> format-comment.md
            echo "Files that need formatting:" >> format-comment.md
            echo "\`\`\`" >> format-comment.md
            git status --porcelain | sed 's/^ M //' >> format-comment.md
            echo "\`\`\`" >> format-comment.md
            
            exit 1
          else
            echo "âœ… Code formatting is perfect!"
            echo "formatting_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Run linter
        id: lint
        run: |
          echo "ðŸ” Running linter..."
          npm run lint || {
            echo "âŒ Linting issues found!"
            echo "lint_issues=true" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "âœ… No linting issues found!"
          echo "lint_issues=false" >> $GITHUB_OUTPUT

  # Job 2: Build
  build:
    name: ðŸ”¨ Build
    runs-on: ubuntu-latest
    needs: quality # Only run if quality checks pass
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: ðŸ”¨ Build project
        run: |
          echo "ðŸ”¨ Building project..."
          npm run build
          echo "âœ… Build successful!"

      - name: ðŸ“Š Check build output
        run: |
          echo "ðŸ“Š Build output summary:"
          echo "Total files in dist: $(find dist -type f | wc -l)"
          echo "Build size: $(du -sh dist | cut -f1)"
          
          # Ensure executable permissions
          chmod +x dist/index.js
          echo "âœ… Executable permissions set"

      - name: ðŸ’¾ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # Job 3: Test
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    needs: quality # Only run if quality checks pass
    strategy:
      matrix:
        node-version: [18, 20, 22] # Test on multiple Node versions
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: ðŸ§ª Run tests
        run: |
          echo "ðŸ§ª Running tests on Node.js ${{ matrix.node-version }}..."
          npm test
          echo "âœ… All tests passed!"

      - name: ðŸ“Š Generate coverage report
        if: matrix.node-version == 22 # Only on latest Node
        run: |
          echo "ðŸ“Š Generating coverage report..."
          npm run test:coverage || true
          
          # Display coverage summary
          if [ -f coverage/coverage-summary.json ]; then
            echo "ðŸ“ˆ Coverage Summary:"
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              console.log('Lines:', total.lines.pct + '%');
              console.log('Statements:', total.statements.pct + '%');
              console.log('Functions:', total.functions.pct + '%');
              console.log('Branches:', total.branches.pct + '%');
            "
          fi

      - name: ðŸ“¤ Upload coverage reports
        if: matrix.node-version == 22
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Job 4: Summary
  summary:
    name: ðŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [quality, build, test]
    if: always() # Run even if other jobs fail
    steps:
      - name: ðŸ“‹ Create summary
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "# ðŸ“‹ Pull Request Check Summary" >> $GITHUB_STEP_SUMMARY
          else
            echo "# ðŸ“‹ Branch Check Summary (${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Quality checks
          if [[ "${{ needs.quality.result }}" == "success" ]]; then
            echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "âœ… **Build**: Successful" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" == "skipped" ]]; then
            echo "â­ï¸ **Build**: Skipped (quality checks failed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Tests
          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "âœ… **Tests**: All passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test.result }}" == "skipped" ]]; then
            echo "â­ï¸ **Tests**: Skipped (quality checks failed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.quality.result }}" != "success" ]]; then
            echo "1. Fix code quality issues (run \`npm run format\` and \`npm run lint\`)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" != "success" ]] && [[ "${{ needs.build.result }}" != "skipped" ]]; then
            echo "1. Fix build errors" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test.result }}" != "success" ]] && [[ "${{ needs.test.result }}" != "skipped" ]]; then
            echo "1. Fix failing tests" >> $GITHUB_STEP_SUMMARY
          else
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              echo "ðŸŽ‰ All checks passed! Your PR is ready for review." >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸŽ‰ All checks passed! The ${{ github.ref_name }} branch is healthy." >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ðŸ’¬ Comment on PR
        if: (failure() || cancelled()) && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = [];
            
            // Add header
            summary.push('## ðŸ” PR Check Results\n');
            
            // Quality checks
            if ('${{ needs.quality.result }}' === 'failure') {
              summary.push('### âŒ Code Quality Issues\n');
              summary.push('Please fix the following:');
              summary.push('- Run `npm run format` to fix formatting issues');
              summary.push('- Run `npm run lint` to see linting errors\n');
            }
            
            // Build
            if ('${{ needs.build.result }}' === 'failure') {
              summary.push('### âŒ Build Failed\n');
              summary.push('The TypeScript build failed. Please check the build logs.\n');
            }
            
            // Tests
            if ('${{ needs.test.result }}' === 'failure') {
              summary.push('### âŒ Tests Failed\n');
              summary.push('Some tests are failing. Please check the test logs.\n');
            }
            
            if (summary.length > 1) {
              summary.push('---');
              summary.push('ðŸ’¡ **Tip**: Click on the job names above to see detailed logs.');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary.join('\n')
              });
            }